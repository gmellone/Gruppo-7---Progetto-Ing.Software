@startuml

skinparam style strictuml
skinparam packageStyle rectangle

title Pattern MVC e Repository per la gestione di Entity generiche

package "pkg init" {
  ' Questo package serve solo a illustrare
  ' il wiring iniziale dell'applicazione
  class MainApp

}

package "View Layer (MVC)" #LightBlue{
  package "pkg UI" #white {
    class EntityView <<View>>
  }
}

note top of EntityView #pink
<b>Responsabilità:
- Mostra i dati dell'Entity
- Inoltra eventi al Controller

Rappresenta il file FXML
di presentazione.

end note

package "Controller Layer (MVC)" #LightBlue {

  package "pkg Service" as Service #white {
    class EntityController <<Controller>>
    class EntityService <<Service>>
  }

}

note top of EntityController #pink
<b>Responsabilità:
- Riceve input dalla View
- Chiama i Service
- Aggiorna la View

Nota bene: i controlli funzionali,
sono implementati nel Service.
Vietato mettere logica di business
nel Controller!

end note

note right of EntityService #pink
<b>Responsabilità:
- Implementa i controlli funzionali
- Invoca il repository per operazioni CRUD
  (Create Read Update Delete)
  sui dati

Nota Bene: non conosce i meccanismi
di persistenza, né la reale
implementazione del Repository,
usa solo la sua interfaccia.


end note

note bottom of EntityService
Questa classe rappresenta l'unico
punto di contatto del Model con il
suo Controller. Il Service
ha la responsabilità di implementare
i controlli funzionali, ad esempio
un utente non può prendere in prestito
più di tre libri, ecc.
Per pulizia architetturale, il Service
utilizza una implementazione di una
interfaccia Repository che gli viene
iniettata in fase di init
(dependency injection), quindi non conosce
la sua reale implementazione, potrebbe
essere un vero DB, un File (come nel caso
del nostro progetto) o altro.
end note

package "Model Layer (MVC)" #LightBlue {

  package "pkg Repository" #white {
    interface EntityRepository <<Repository>>
    class FileBackedEntityRepository
  }

  package "pkg Persistence" as Persistence #white {
    class FileManager <<Persistence>>
  }

  package "pkg Model" #white {
    class Entity <<Entity>>
  }

}
' --- Note MVC ---

note top of FileBackedEntityRepository
Per semplicità espositiva,
abbiamo omesso il dettaglio
dell'utilizzo di InMemoryRepository.
L'implementazione di questo tipo
di Repository sarà spiegata in un
documento ad-hoc
end note

note top of EntityRepository #pink
  <b>Responsabilità:
  - Interfaccia generica che implementa
    le operazioni CRUD sui dati
  - Implementa oltre alle operazioni di base
  (attraverso l'uso di CRUDRepository<T>),
  anche operazioni specifiche
  per l'Entity, ad esempio
  findByAttributeX(...)

Nota Bene: la reale implementazione
del Repository è nascosta
all'interno del Model, il Service
usa solo questa interfaccia. In caso
di cambiamento della strategia
di persistenza (ad esempio da File
a DB), il Service non ne sarà
affetto.
end note

note top of FileBackedEntityRepository #pink
<b>Responsabilità:
  - Implementa l'interfaccia
    EntityRepository
  - Incapsula la logica di persistenza
    su file

Nota: se fosse necessario cambiare
la strategia di persistenza,
ad esempio passando da File
a Database, basterebbe creare
una nuova implementazione di
EntityRepository, ad esempio
DatabaseBackedEntityRepository,
senza modificare il Service
che usa solo l'interfaccia.
Ovviamente, in fase di init
dell'applicazione, andrebbe
iniettata questa nuova implementazione
nel Service (vedi MainApp)
end note

note right of FileManager #pink
<b>Responsabilità:
  - Fornisce metodi generici
    per leggere/scrivere dati su file
end note

note top of Entity #pink
<b>Responsabilità:
  - Rappresenta l'entità di dominio
    gestita dall'applicazione
end note

note top of EntityView
  VIEW (MVC): componente di presentazione (FXML)
  mostra i dati dell'Entity e inoltra eventi al Controller
end note

note top of EntityController
  CONTROLLER (MVC): riceve input dalla View,
  chiama i Service e aggiorna la View
end note

note right of Entity
  MODEL (MVC): entità di dominio gestite
  da Service/Repository
end note

note top of EntityRepository
  MODEL (Repository): interfaccia
  che incapsula l'accesso ai dati
  (fa parte del Model nell'MVC)
end note

note top of FileManager
  MODEL (Persistence): dettaglio
  infrastrutturale
  per la persistenza su file
end note

' --- Wiring UI ---
MainApp --> EntityController : crea e\ninietta EntityService
EntityController --> EntityView

' --- Controller -> Service ---
EntityController --> EntityService

' --- Service -> Repository ---
EntityService --> EntityRepository
FileBackedEntityRepository ..|> EntityRepository

' --- Repository -> Persistence ---
FileBackedEntityRepository --> FileManager : loadEntities/saveEntities

' --- Model ---
EntityService --> Entity
FileManager --> Entity : legge/scrive\nentity-data.txt

@enduml
